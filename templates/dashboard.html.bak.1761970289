{% extends "base.html" %}
{% block content %}{% set _controllers = (controllers or {}) %}
{% set _charts = (charts or {
  'device_seen': {'labels':[],'values':[],'raw_values':[],'baseline_const':0},
  'vehicle':     {'labels':[],'values':[],'raw_values':[],'baseline_const':0}
}) %}
{% set _params = (params or {'group':'min','tzname':'America/Chicago'}) %}
{% set _peaks = (peaks or {'device_seen':{'label':'—','count':0}, 'vehicle':{'label':'—','count':0}}) %}

<div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;margin-bottom:0.75rem;">
  <div><em>Times shown in {{ _params.get('tzname','America/Chicago') }}</em></div>
  <form method="post" action="/admin/sync-baldrick" style="margin:0;">
    <button type="submit">Sync Now</button>
  </form>
</div>{% set _controllers = (controllers or {}) %}
{% set _charts = (charts or {'device_seen':{'labels':[],'values':[],'raw_values':[],'baseline_const':0}}) %}
{% set _params = (params or {'group':'min'}) %}
{% set _peaks = (peaks or {'device_seen':{'label':'—','count':0}, 'vehicle':{'label':'—','count':0}}) %}

{% set _peaks = (peaks or {"device_seen":{"label":"—","count":0},"vehicle":{"label":"—","count":0}}) %}
{% set _controllers = (controllers or {}) %}
{% set _charts = (charts or {"device_seen":{"labels":[],"values":[],"raw_values":[],"baseline_const":0}}) %}
{% set _params = (params or {"group":"min"}) %}
<h2 style="margin:0 0 12px 0;">Dashboard</h2>

{% if alerts and alerts|length>0 %}
<div class="card" style="border:1px solid #7f1d1d; background:#431313;">
  <strong>Alerts</strong>
  <ul>
    {% for a in alerts %}<li>{{ a.timestamp }} — {{ a.message }}</li>{% endfor %}
  </ul>
</div>
{% endif %}

<form method="get" action="/dashboard" class="card" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:12px; align-items:end; margin-bottom:16px;">
  <div>
    <label>From (YYYY-MM-DD)</label>
    <input type="text" name="from" value="{{ params.get('from','') }}">
  </div>
  <div>
    <label>To (YYYY-MM-DD)</label>
    <input type="text" name="to" value="{{ params.get('to','') }}">
  </div>
  <div>
    <label>Camera</label>
    <select name="camera">
      <option value="">All</option>
      {% for c in cameras %}
        <option value="{{ c }}">{{ c }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Season</label>
    <select name="season">
      <option value="">All</option>
      {% for s in seasons %}
        <option value="{{ s.name }}" {% if params.get('season','')==s.name %}selected{% endif %}>{{ s.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label>Group By</label>
    <select name="group">
      <option value="day" {% if params.get('group','day')=='day' %}selected{% endif %}>Day</option>
      <option value="hour" {% if params.get('group')=='hour' %}selected{% endif %}>Hour</option>
    </select>
  </div>
  <div>
    <button type="submit">Update</button>
  </div>
</form>


<div class="cards" style="margin-bottom:16px;">
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Controllers</h3>
    <div>
      <span style="display:inline-block;padding:4px 10px;border-radius:999px;background:#0b3b1e;color:#d1fae5;border:1px solid #065f46;">
        Online {{ (_controllers.get('online', 0)) }} / {{ (_controllers.get('total', 0)) }}
      </span>
      <span class="muted" style="margin-left:8px;">Falcon & FPP</span>
    </div>
  </div>
  <div class="card">
    <h3 style="margin:0 0 8px 0;">FPP Now Playing</h3>
    {% if fpp %}
      <div class="muted">Host: {{ fpp.hostname or '—' }} · Version: {{ fpp.version or '—' }}</div>
      <div style="margin-top:8px;"><strong>{{ fpp.playlist or 'No Playlist' }}</strong></div>
      <div>{{ fpp.media or '—' }}</div>
      <div class="muted" style="margin-top:6px;">State: {{ fpp.state or 'unknown' }}</div>
    {% else %}
      <div class="muted">No FPP controller detected yet.</div>
    {% endif %}
  </div>
</div>

<div class="cards">
  <div class="card">
    <h3 style="margin-top:0;">Combined Vehicles (Tripline)</h3>
    <canvas id="vehChart"></canvas>
  </div>
  <div class="card">
    <h3 style="margin-top:0;">Device Presence (Baldrick)</h3>
    <canvas id="devChart"></canvas>
  </div>
</div>


<div class="cards" style="margin-top:16px;">
  <div class="card">
    <h3 style="margin:0 0 8px 0;">Top Media (by Vehicles)</h3>
    <ol>
      {% for row in top_media %}
        <li>{{ row.label }} — {{ row.count }}</li>
      {% endfor %}
    </ol>
  </div>
</div>

<div class="cards" style="margin-top:16px;">
<div class="card" style="grid-column: 1 / -1;">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3 style="margin:0;">Vehicles by What Was Playing</h3>
    <form method="get" action="/dashboard">
      <input type="hidden" name="from" value="{{ params.get('from','') }}">
      <input type="hidden" name="to" value="{{ params.get('to','') }}">
      <input type="hidden" name="season" value="{{ params.get('season','') }}">
      <input type="hidden" name="group" value="{{ params.get('group','day') }}">
      <label class="muted">Group:</label>
      <select name="corr">
        <option value="media" {% if params.get('corr','media')=='media' %}selected{% endif %}>Media</option>
        <option value="playlist" {% if params.get('corr')=='playlist' %}selected{% endif %}>Playlist</option>
      </select>
      <button type="submit">Update</button>
    </form>
  </div>
  <canvas id="corrChart" style="margin-top:10px;"></canvas>
</div>

  <div class="card">
    <h3 style="margin-top:0;">Peak Times</h3>
    <p class="muted">Shows busiest {{ 'day' if params.get('group','day')=='day' else 'hour' }} in the selected range.</p>
    <ul>
      <li><strong>Vehicles:</strong> {{ (_peaks.get("vehicle", {}).get("label", "—")) }} — {{ (_peaks.get("vehicle", {}).get("count", 0)) }}</li>
      <li><strong>Devices:</strong> {{ (_peaks.get("device_seen",{}).get("label","—")) }} — {{ (_peaks.get("device_seen",{}).get("count",0)) }}</li>
    </ul>
  </div>
  <div class="card">
    <h3 style="margin-top:0;">Totals</h3>
    <ul>
      <li>Vehicles total: {{ totals.vehicle }}</li>
      <li>Devices total: {{ totals.device_seen }}</li>
    </ul>
  </div>
</div>

<script>
const veh = {{ (_charts.get('vehicle', {'labels':[],'values':[],'raw_values':[],'baseline_const':0})) | tojson }};
const dev = {{ (_charts.get('device_seen', {'labels':[],'values':[],'raw_values':[],'baseline_const':0})) | tojson }};

function mkChart(id, data, label){
  const ctx = document.getElementById(id).getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: label,
        data: data.values,
        tension: 0.25,
        pointRadius: 0,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: { ticks: { color: '#cbd5e1' } },
        y: { ticks: { color: '#cbd5e1' } }
      },
      plugins: { legend: { labels: { color:'#e5e7eb' } } }
    }
  });
}

mkChart('vehChart', veh, 'Vehicles');
mkChart('devChart', dev, 'Devices');

fetch(`/correlate?group={{ params.get('corr','media') }}&season={{ params.get('season','') }}&date_from={{ params.get('from','') }}&date_to={{ params.get('to','') }}`)
  .then(r=>r.json())
  .then(d=>{
    const labels = d.series.map(x=>x.label);
    const values = d.series.map(x=>x.count);
    const ctx = document.getElementById('corrChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Vehicles', data: values, borderWidth: 1 }] },
      options: { responsive:true, scales:{ x:{ ticks:{ color:'#cbd5e1' } }, y:{ ticks:{ color:'#cbd5e1' } } },
                 plugins:{ legend:{ labels:{ color:'#e5e7eb' } } } }
    });
  });

</script>
{% endblock %}

<button id="resetZoom" class="btn">Reset Zoom</button>
<script>
  // enable zoom/pan on the two charts if they exist
  for (const id of ['chart-vehicle','chart-device_seen']) {
    const c = window._charts && window._charts[id];
    if (c) {
      c.options.plugins = c.options.plugins || {};
      c.options.plugins.zoom = {
        zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' },
        pan:  { enabled: true, mode: 'x' }
      };
      c.update();
    }
  }
  document.getElementById('resetZoom')?.addEventListener('click', () => {
    for (const id of ['chart-vehicle','chart-device_seen']) {
      const c = window._charts && window._charts[id];
      if (c && c.resetZoom) c.resetZoom();
    }
  });
</script>
<form method="get" action="/dashboard" style="margin:8px 0">
  <label>Group:</label>
  <select name="group">
    <option value="min">Minute</option>
    <option value="hour" selected>Hour</option>
    <option value="day">Day</option>
  </select>
  <button type="submit">Apply</button>
</form>
<!-- GS_DASH_AUTOREFRESH -->
<script>
  (function(){
    // 60s auto-refresh; set to 0 to disable
    var REFRESH_SECONDS = 60;
    if (!REFRESH_SECONDS) return;

    let paused = false;
    // If you zoom/pan the chart, pause refresh briefly so it doesn't interrupt
    document.addEventListener('wheel', () => { paused = true; setTimeout(()=>paused=false, 2000); }, {passive:true});
    document.addEventListener('pointerdown', () => { paused = true; setTimeout(()=>paused=false, 2000); }, {passive:true});

    setInterval(function(){
      if (!paused) { window.location.reload(); }
    }, REFRESH_SECONDS * 1000);
  })();
</script>


<!-- GS: overlay raw vs adjusted + baseline line + small trend -->
<script>
(function(){
  try {
    const data = {{ charts|tojson }};
    const rec = {{ recommended_baseline|default(0) }};
    const trend = {{ baseline_trend|tojson|default({'labels':[],'values':[]}) }};

    // 1) Overlay on the existing device_seen chart if present
    var chart = (window._charts && window._charts['chart-device_seen']) ? window._charts['chart-device_seen'] : null;
    if (chart && data && data.device_seen) {
      const labels = data.device_seen.labels || [];
      const raw = data.device_seen.raw_values || data.device_seen.values || [];
      const adj = data.device_seen.adj_values || data.device_seen.values || [];
      const baselineConst = data.device_seen.baseline_const || 0;

      // Replace datasets with Raw + Adjusted + Baseline line
      chart.data.labels = labels;
      chart.data.datasets = [
        { label: 'Adjusted (raw - baseline)', data: adj, borderWidth: 2, tension: 0.2 },
        { label: 'Raw', data: raw, borderDash: [6,4], borderWidth: 2, tension: 0.2 },
        { label: 'Baseline', data: labels.map(()=>baselineConst), borderDash: [2,2], pointRadius: 0, borderWidth: 1, tension: 0 }
      ];
      chart.update();
    }

    // 2) Add a small Baseline Trend chart under the device chart if not present
    if (!document.getElementById('baseline-trend')) {
      const wrap = document.querySelector('#chart-device_seen')?.closest('div') || document.body;
      const c = document.createElement('canvas');
      c.id = 'baseline-trend';
      c.style.marginTop = '8px';
      wrap.appendChild(c);

      if (window.Chart && trend && trend.labels && trend.labels.length) {
        new Chart(c.getContext('2d'), {
          type: 'line',
          data: { labels: trend.labels, datasets: [{ label: 'Baseline Trend (daily 10th pct)', data: trend.values, borderWidth: 2, pointRadius: 0, tension: 0.2 }] },
          options: { responsive: true, scales: { x: { display: true }, y: { beginAtZero: true } } }
        });
      } else {
        c.outerHTML = '<div id="baseline-trend" style="opacity:.6;font-size:12px;margin-top:6px;">No baseline history yet</div>';
      }
    }

    // 3) If you expose recommended baseline somewhere, you can show it like:
    //   document.querySelector('#rec-base')?.innerText = rec;
  } catch(e) { console.warn('GS overlay script:', e); }
})();
</script>
